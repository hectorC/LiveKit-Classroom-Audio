<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LiveKit Classroom – Teacher</title>
  <link rel="stylesheet" href="/styles.css" />
</head>

<body class="page page--teacher">
  <main class="shell">
    <header class="hero">
      <span class="hero__tag">Teacher Console</span>
      <h1>Broadcast Studio Control</h1>
      <p>Route any creative audio source into the classroom space. Pick a device, go live, and let the mix flow.
      </p>
    </header>

    <section class="panel">
      <div class="status-block">
        <span class="status-label">Status</span>
        <span class="status-pill" id="statusPill" data-state="disconnected">
          <span id="status">Not connected</span>
        </span>
      </div>

      <div class="control-grid">
        <div>
          <label for="deviceSelect">Audio source</label>
          <select id="deviceSelect"></select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="refreshDevices" type="button">Refresh devices</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="connectBtn" type="button">Connect &amp; Publish Audio</button>
        </div>
      </div>

      <div class="timeline">
        <div class="timeline__step">
          <span class="timeline__dot"></span>
          <span class="timeline__text">Use Refresh to reveal every connected interface or virtual cable.</span>
        </div>
        <div class="timeline__step">
          <span class="timeline__dot"></span>
          <span class="timeline__text">When you connect, the room opens instantly for every listener.</span>
        </div>
        <div class="timeline__step">
          <span class="timeline__dot"></span>
          <span class="timeline__text">Disconnect to free the lane and let another set take over.</span>
        </div>
      </div>
      <p class="footer-note">LiveKit stream • Stereo opus • LAN only</p>
    </section>
  </main>

  <!-- LiveKit JS SDK (served locally for offline LAN use) -->
  <script src="/livekit-client.umd.min.js"></script>

  <script>
    const statusEl = document.getElementById('status');
    const button = document.getElementById('connectBtn');
    const deviceSelect = document.getElementById('deviceSelect');
    const refreshBtn = document.getElementById('refreshDevices');
    const statusPill = document.getElementById('statusPill');

    // LiveKit server URL based on current host
    const wsUrl = "ws://" + window.location.hostname + ":7880";

    let room = null;
    let audioDevices = [];

    function updateStatus(message, state = 'disconnected') {
      statusEl.textContent = message;
      statusPill.dataset.state = state;
    }

    async function populateAudioInputs(requestAccess = false) {
      try {
        if (requestAccess) {
          const tempStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          tempStream.getTracks().forEach(track => track.stop());
        }
      } catch (err) {
        console.warn('Microphone permission denied or unavailable:', err);
      }

      audioDevices = (await navigator.mediaDevices.enumerateDevices())
        .filter(d => d.kind === "audioinput");

      deviceSelect.innerHTML = "";
      if (!audioDevices.length) {
        const opt = document.createElement('option');
        opt.value = "";
        opt.textContent = "No audio inputs found";
        deviceSelect.appendChild(opt);
        return;
      }

      audioDevices.forEach(device => {
        const opt = document.createElement('option');
        opt.value = device.deviceId;
        opt.textContent = device.label || `Input ${device.deviceId}`;
        deviceSelect.appendChild(opt);
      });
    }

    async function fetchTeacherToken() {
      const res = await fetch("/token/teacher");
      const data = await res.json();

      console.log("Teacher identity:", data.identity);
      console.log("Raw token value from server:", data.token);

      let token = data.token;

      // If the token comes back as an object, try to extract the actual JWT
      if (typeof token === "object" && token !== null) {
        if (typeof token.jwt === "string") {
          token = token.jwt;
        } else if (typeof token.token === "string") {
          token = token.token;
        } else {
          // Last resort: stringify it so we can see what it is
          console.warn("Unexpected token object shape:", token);
          token = JSON.stringify(token);
        }
      }

      token = String(token);
      console.log("Teacher token typeof (fixed):", typeof token);
      console.log("Teacher token sample:", token.slice(0, 40));

      return token;
    }


    async function start() {
      try {
        updateStatus("Connecting...", 'disconnected');

        // 1. Get a teacher token
        const token = await fetchTeacherToken();
        console.log("Teacher token typeof:", typeof token);
        console.log("Teacher token sample:", token.slice(0, 40));


        // 2. Create and connect room
        const selectedDeviceId = deviceSelect.value;
        if (!selectedDeviceId) {
          alert("Select an audio input before connecting.");
          updateStatus("Select an input device", 'error');
          return;
        }

        room = new LivekitClient.Room();
        await room.connect(wsUrl, token);
        updateStatus("Connected. Initializing audio input...", 'connected');

        room.on(LivekitClient.RoomEvent.Disconnected, () => {
          updateStatus("Disconnected", 'disconnected');
          button.disabled = false;
        });

        // 3. Create a hi-fi stereo audio track from the chosen device
        const audioTrack = await LivekitClient.createLocalAudioTrack({
          deviceId: selectedDeviceId,
          channelCount: 2,
          echoCancellation: false,
          noiseSuppression: false,
          autoGainControl: false,
        });

        console.log("Local track settings:", audioTrack.mediaStreamTrack.getSettings());

        // 5. Publish with high-quality stereo preset
        const pub = await room.localParticipant.publishTrack(audioTrack, {
          audioPreset: LivekitClient.AudioPresets.musicHighQualityStereo,
          dtx: false,
          red: false,
          forceStereo: true,
        });

        console.log("Published track:", pub);
        updateStatus(`Publishing stereo audio from ${deviceSelect.selectedOptions[0].textContent}.`, 'connected');
        button.disabled = true;

      } catch (e) {
        console.error(e);
        updateStatus("Error: " + e, 'error');
      }
    }

    button.addEventListener('click', start);
    refreshBtn.addEventListener('click', () => populateAudioInputs(true));
    if (navigator.mediaDevices?.addEventListener) {
      navigator.mediaDevices.addEventListener('devicechange', () => populateAudioInputs());
    }
    populateAudioInputs(true);
  </script>
</body>

</html>